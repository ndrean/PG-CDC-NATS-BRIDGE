services:
  bridge-init:
    image: postgres:18
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./init.sql.template:/init.sql.template:ro # Add template
    env_file:
      - .env.prod
    environment:
      # Use superuser credentials to create publication (override postgres image defaults)
      PGHOST: ${PG_HOST}
      PGPORT: ${PG_PORT}
      PGUSER: ${PG_USER}
      PGPASSWORD: ${PG_PASSWORD}
      PGDATABASE: ${PG_DB}
      # Pass bridge user credentials to init script
      POSTGRES_BRIDGE_USER: ${POSTGRES_BRIDGE_USER}
      POSTGRES_BRIDGE_PASSWORD: ${POSTGRES_BRIDGE_PASSWORD}
      TARGET_DB: ${TARGET_DB}
      BRIDGE_CDC_TABLES: ${BRIDGE_CDC_TABLES}
      BRIDGE_CDC_PUBLICATION: ${BRIDGE_CDC_PUBLICATION}
    command:
      - /bin/bash
      - -c
      - |
        set -ex
        echo "[bridge-init] Command section started!"
        echo "[bridge-init] Waiting for Postgres to be ready..."
        until pg_isready -h "$${PGHOST}" -p "$${PGPORT}" -U "$${PGUSER}"; do
          echo "  Postgres not ready, waiting..."
          sleep 1
        done
        echo "[bridge-init] Running initialization script..."
        apt-get update && apt-get install -y gettext-base
        envsubst < /init.sql.template | psql -v ON_ERROR_STOP=1 -h "$${PGHOST}" -p "$${PGPORT}" -U "$${PGUSER}" -d "$${PGDATABASE}"

        echo "[bridge-init] Initialization complete!"
    networks:
      - cdc-bridge
    restart: "no"

  bridge:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: bridge
    ports:
      - "${BRIDGE_PORT}:${BRIDGE_PORT}"
    depends_on:
      bridge-init:
        condition: service_completed_successfully
      postgres:
        condition: service_healthy
      nats-init:
        condition: service_completed_successfully
    env_file:
      - .env.prod
    command:
      - "--slot"
      - "${BRIDGE_CDC_SLOT}"
      - "--pub"
      - "${BRIDGE_CDC_PUBLICATION}"
      - "--port"
      - "${BRIDGE_PORT}"
      - "--msgpack"
      # - "--zstd"

    networks:
      - cdc-bridge
    restart: unless-stopped

  postgres:
    extends:
      file: docker-compose.yml
      service: postgres

  nats-config-gen:
    extends:
      file: docker-compose.yml
      service: nats-config-gen
  nats-server:
    extends:
      file: docker-compose.yml
      service: nats-server

  nats-init:
    extends:
      file: docker-compose.yml
      service: nats-init

volumes:
  postgres-data:
    driver: local
  nats-data:
    driver: local
  nats-config:
    driver: local

networks:
  cdc-bridge:
    driver: bridge
